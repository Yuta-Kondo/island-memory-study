---
title: "Island Memoryâ€‘Card Study"
format:
  html: default
execute:
  freeze: auto
---

```{r setup, message=FALSE, warning=FALSE}
# Source helper functions
source("R/load_packages.R")
source("R/clean_data.R")
source("R/modeling.R") # Corrected filename
source("R/plotting.R") # Corrected filename

# Load packages
load_packages() 

# Load and clean data 
# Ensure 'island_data.csv' is in 'data/raw/' before running
clean_df <- get_clean_data("data/raw/island_data.csv") 

# Fit basic ANOVA models
anova_models <- fit_anova_models(clean_df)

# Define formula for the more complex additive model (used for Box-Cox)
formula_additive <- Memory.card.score ~ Treatment + Age + Location + Gender + Education.Level

# Fit Box-Cox transformed additive model
bc_additive_results <- fit_boxcox_transformed_model(formula_additive, clean_df)
bc_additive_model <- bc_additive_results$transformed_model
optimal_lambda_additive <- bc_additive_results$lambda

# Optional: Fit Box-Cox transformed RCB model (if needed for comparison)
# formula_rcb <- Memory.card.score ~ Treatment + age_group
# bc_rcb_results <- fit_boxcox_transformed_model(formula_rcb, clean_df)
# bc_rcb_model <- bc_rcb_results$transformed_model
# optimal_lambda_rcb <- bc_rcb_results$lambda
```

## 1  Exploratory Data Analysis (EDA)

```{r eda-summary}
# Display structure of the cleaned data
dplyr::glimpse(clean_df)

# Display summary statistics for all variables
summary(clean_df)

# Optional: Detailed summary for quantitative variables
# summary(clean_df$Age)
# sd(clean_df$Age)
# summary(clean_df$Memory.card.score)
# sd(clean_df$Memory.card.score)

# Optional: Frequency tables for qualitative variables
# table(clean_df$Location) |> prop.table() * 100
# table(clean_df$Gender) |> prop.table() * 100
# table(clean_df$Education.Level) |> prop.table() * 100
# table(clean_df$Treatment) |> prop.table() * 100
```

```{r eda-plots}
# Example plots (customize as needed)
# Boxplot of score by treatment
ggplot2::ggplot(clean_df, ggplot2::aes(x = Treatment, y = Memory.card.score, fill = Treatment)) +
  ggplot2::geom_boxplot() +
  ggplot2::labs(title = "Memory Score Distribution by Treatment") +
  ggplot2::theme_minimal()

# Histogram of Age
ggplot2::ggplot(clean_df, ggplot2::aes(x = Age)) +
  ggplot2::geom_histogram(binwidth = 5, fill = "lightblue", color = "black") +
  ggplot2::labs(title = "Distribution of Age") +
  ggplot2::theme_minimal()
  
# Linearity check plot (from original script)
plot_linearity_check(clean_df, x_var = "Age", y_var = "Memory.card.score", color_var = "Treatment")
```

*Interpret the structure, summary statistics, and plots. Comment on distributions, potential outliers, and relationships between variables.*

## 2  One-way ANOVA

```{r anova-one-way-fit}
# Display ANOVA summary for the one-way model
summary(anova_models$one_way)
```

```{r anova-one-way-diagnostics}
# Check model assumptions using performance::check_model
performance::check_model(anova_models$one_way, check = c("normality", "homogeneity"))

# Alternatively, use custom plots:
# plot_qq(anova_models$one_way, title = "Q-Q Plot: One-Way ANOVA Residuals")
# plot_homogeneity(anova_models$one_way, title = "Homogeneity Check: One-Way ANOVA")
```

*Interpret the one-way ANOVA results (effect of Treatment alone) and the diagnostic checks (normality and homogeneity of variances).*

## 3  Randomised Complete Block (RCB) Design

```{r anova-rcb-fit}
# Display ANOVA summary for the RCB model (blocking by age_group)
summary(anova_models$rcb)

# Check for additivity (interaction between Treatment and age_group)
# A non-significant interaction term supports the additive RCB model
summary(anova_models$interaction) 
```

```{r anova-rcb-diagnostics}
# Check model assumptions for the RCB model
performance::check_model(anova_models$rcb, check = c("normality", "homogeneity"))

# Optional: Shapiro-Wilk test (from original script)
# shapiro.test(residuals(anova_models$rcb))

# Optional: Custom diagnostic plots
# plot_qq(anova_models$rcb, title = "Q-Q Plot: RCB Residuals")
# plot_homogeneity(anova_models$rcb, title = "Homogeneity Check: RCB")
```

*Interpret the RCB results (effect of Treatment after accounting for age_group) and the additivity check. Discuss the diagnostic plots/tests.*

## 4  Analysis with Box-Cox Transformation (Additive Model)

This section analyzes the additive model (`Memory.card.score ~ Treatment + Age + Location + Gender + Education.Level`) after applying a Box-Cox transformation to the response variable.

```{r box-cox-additive-fit}
# Display the optimal lambda found for the additive model
cat("Optimal Lambda (Additive Model):", optimal_lambda_additive, "\n")

# Display summary of the linear model fitted with the transformed response
summary(bc_additive_model)

# Display ANOVA table for the transformed additive model
# anova(bc_additive_model) # Use stats::anova if needed
```

```{r box-cox-additive-diagnostics}
# Check assumptions for the transformed additive model
# Using performance::check_model
performance::check_model(bc_additive_model, check = c("normality", "homogeneity"))

# Using custom plots (matching original technical_report.R)
plot_qq(bc_additive_model, title = "Q-Q Plot: Transformed Additive Model Residuals")
plot_homogeneity(bc_additive_model, title = "Homogeneity Check: Transformed Additive Model")
```

*Interpret the results of the additive model using the Box-Cox transformed response. Discuss the significance of predictors and the improvement (or lack thereof) in meeting model assumptions based on the diagnostic plots.*

## 5 Optional: Box-Cox Transformation for RCB Model

If you need to compare the transformed RCB model:

```{r box-cox-rcb, eval=FALSE} # Set eval=TRUE to run this chunk
# Define formula for RCB model
formula_rcb <- Memory.card.score ~ Treatment + age_group
# Fit Box-Cox transformed RCB model
bc_rcb_results <- fit_boxcox_transformed_model(formula_rcb, clean_df)
bc_rcb_model <- bc_rcb_results$transformed_model
optimal_lambda_rcb <- bc_rcb_results$lambda

cat("Optimal Lambda (RCB Model):", optimal_lambda_rcb, "\n")
summary(bc_rcb_model)

# Diagnostics
performance::check_model(bc_rcb_model, check = c("normality", "homogeneity"))
# plot_qq(bc_rcb_model, title = "Q-Q Plot: Transformed RCB Model Residuals")
# plot_homogeneity(bc_rcb_model, title = "Homogeneity Check: Transformed RCB Model")
```

*Interpret results if this section is evaluated.*

---

*Final conclusions summarizing the findings.*
